<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RPG Dice Roller</title>
  <style>
    body { font-family: system-ui; background: #0f172a; color: #e5e7eb; margin:0; padding:0.5rem; }
    header { margin-bottom:0.5rem; font-size:18px; }
    .btn { background:#2563eb; color:white; border:none; padding:10px 14px; border-radius:6px; cursor:pointer; font-size:16px; margin:2px; }
    .btn.ghost { background:#0b1730; border:1px solid #334155; }
    .btn.selected { background:#16a34a !important; } /* highlight selected dice */
    .btn.mod { background:#1e40af; } /* blue modifier +/- */
    .row { display:flex; flex-wrap:wrap; margin-bottom:8px; gap:6px; align-items:center; }
    .count-control, .mod-control { display:flex; align-items:center; }
    .count-control button, .mod-control button { font-size:20px; padding:8px 12px; margin:0 4px; }
    .count-display, .mod-display { font-size:18px; min-width:140px; text-align:center; background:#1e293b; border-radius:6px; padding:8px 10px; border:1px solid #334155; }
    .card { background:#1e293b; padding:10px; border-radius:6px; margin-top:0.5rem; }
    .history-item { border-bottom:1px solid #334155; padding:4px 0; font-size:14px; }
    input[type=number] { padding:6px; border-radius:4px; border:none; font-size:16px; width:100px; }
    #settings { margin:6px 0; font-size:14px; color:#a3e635; }
    .roll-low { color:#ef4444; }
    .roll-mid { color:#eab308; }
    .roll-high { color:#22c55e; }
    .mode-label { font-weight:bold; color:#38bdf8; margin-left:6px; }
    @media (max-width:600px){
      .btn { font-size:14px; padding:8px 10px; }
      .count-display, .mod-display { min-width:120px; }
      input[type=number] { width:90px; }
    }
  </style>
</head>
<body>
<div class="container">
  <header>ðŸŽ² RPG Dice Roller</header>

  <!-- Dice selection row -->
  <div class="row" id="diceRow"></div>

  <!-- Count row -->
  <div class="row">
    <label>Number of dices (Disadv., Adv, 1,2,...,20):</label>
    <div class="count-control">
      <button id="decrCount" class="btn">â€“</button>
      <div id="countDisplay" class="count-display" aria-live="polite">1</div>
      <input id="count" type="hidden" value="1" />
      <button id="incrCount" class="btn">+</button>
    </div>
  </div>

  <!-- Modifier row with +/- buttons -->
  <div class="row">
    <label>Modifier:</label>
    <div class="mod-control">
      <button id="decrMod" class="btn mod">â€“</button>
      <div id="modDisplay" class="mod-display">0</div>
      <input id="modifier" type="hidden" value="0" />
      <button id="incrMod" class="btn mod">+</button>
    </div>
  </div>

  <div class="row">
    <button id="rollBtn" class="btn">Roll</button>
  </div>

  <div id="settings"></div>

  <section class="card" id="currentCard" hidden>
    <h3>Result <span id="modeBadge" class="mode-label"></span></h3>
    <div id="attempts"></div>
    <div id="final"></div>
  </section>

  <section class="card">
    <h3>History <button id="clearHistory" class="btn small">Clear</button></h3>
    <div id="history"></div>
  </section>
</div>

<script>
const STORAGE_KEY='rpg_dice_history_v2';
const diceFaces=[2,3,4,6,8,10,12,20,30,60,100];
const diceRow=document.getElementById('diceRow');

const state={faces:6,count:1,modifier:0,mode:'normal',history:[]};

function buildDiceButtons(){
  diceRow.innerHTML='';
  diceFaces.forEach(f=>{
    const b=document.createElement('button');
    b.textContent='d'+f;
    b.className='btn';
    if(f===state.faces) b.classList.add('selected');
    b.onclick=()=>{
      state.faces=f;
      updateSettings();
      highlightSelectedDice();
    };
    diceRow.appendChild(b);
  });
}

function highlightSelectedDice(){
  const buttons=diceRow.querySelectorAll('button');
  buttons.forEach(btn=>{
    btn.classList.remove('selected');
    if(btn.textContent==='d'+state.faces){
      btn.classList.add('selected');
    }
  });
}

function randInt(max){return Math.floor(Math.random()*max)+1;}
function basicRoll(faces,count){const rolls=[];for(let i=0;i<count;i++)rolls.push(randInt(faces));return rolls;}

function colorizeRoll(value,faces){
  if(value===1) return `<span class="roll-low">${value}</span>`;
  if(value===faces) return `<span class="roll-high">${value}</span>`;
  if(value<=Math.ceil(faces/3)) return `<span class="roll-low">${value}</span>`;
  if(value>=Math.floor(2*faces/3)) return `<span class="roll-high">${value}</span>`;
  return `<span class="roll-mid">${value}</span>`;
}

function performRoll(){
  state.count=parseInt(document.getElementById('count').value);
  state.modifier=parseInt(document.getElementById('modifier').value);

  function oneRoll(numDice){
    const n = Math.max(1, numDice|0);
    const rolls=basicRoll(state.faces, n);
    const sum=rolls.reduce((a,b)=>a+b,0);
    return {rolls,sum};
  }

  let attempt;
  if(state.count>0){
    const a=oneRoll(state.count);
    attempt={ rolls:a.rolls, sum:a.sum, mode:'normal' };
    state.mode='normal';
  } else if(state.count===0){
    const r1=basicRoll(state.faces,1)[0];
    const r2=basicRoll(state.faces,1)[0];
    attempt={ rolls:[r1,r2], sum:Math.max(r1,r2), mode:'adv' };
    state.mode='adv';
  } else if(state.count===-1){
    const r1=basicRoll(state.faces,1)[0];
    const r2=basicRoll(state.faces,1)[0];
    attempt={ rolls:[r1,r2], sum:Math.min(r1,r2), mode:'dis' };
    state.mode='dis';
  } else {
    const a=oneRoll(1);
    attempt={ rolls:a.rolls, sum:a.sum, mode:'normal' };
    state.mode='normal';
  }

  const final=attempt.sum + state.modifier;
  renderCurrent([attempt], final);
  state.history.unshift({t:Date.now(), attempt, final, faces:state.faces});
  saveHistory();
  renderHistory();
}

function renderCurrent(attempts,final){
  currentCard.hidden=false;
  const attemptsEl=document.getElementById('attempts');
  const finalDiv=document.getElementById('final');
  const badge=document.getElementById('modeBadge');
  attemptsEl.innerHTML='';

  const a=attempts[0];
  const colored=a.rolls.map(r=>colorizeRoll(r,state.faces)).join(', ');
  const arrowResult = (a.mode==='adv' || a.mode==='dis') ? ` â†’ <strong>${a.sum}</strong>` : ' â‡’ <strong>'+a.sum+'</strong>';
  const line = `<span>[${colored}]</span>${arrowResult}`;
  const div=document.createElement('div');
  div.className='history-item';
  div.innerHTML=line;
  attemptsEl.appendChild(div);

  badge.textContent = a.mode==='adv' ? 'Advantage' : a.mode==='dis' ? 'Disadvantage' : '';
  finalDiv.textContent='Total: '+final;
  updateSettings();
}

function renderHistory(){
  const historyEl=document.getElementById('history');
  historyEl.innerHTML='';
  state.history.forEach(h=>{
    const div=document.createElement('div');
    div.className='history-item';
    const time=new Date(h.t).toLocaleTimeString();
    const a=h.attempt;
    const colored=a.rolls.map(r=>colorizeRoll(r,h.faces)).join(', ');
    const arrowResult = (a.mode==='adv' || a.mode==='dis') ? ` â†’ <strong>${a.sum}</strong>` : ` â‡’ <strong>${a.sum}</strong>`;
    const modeLabel = a.mode==='adv' ? ' <span class="mode-label">Advantage</span>' : a.mode==='dis' ? ' <span class="mode-label">Disadvantage</span>' : '';
    div.innerHTML=`${time}${modeLabel}<br/>[${colored}]${arrowResult}  |  Total: <strong>${h.final}</strong>`;
    historyEl.appendChild(div);
  });
}

function updateCountDisplay(){
  const cnt = parseInt(document.getElementById('count').value);
  const disp = document.getElementById('countDisplay');
  if (cnt===0) disp.textContent='Advantage';
  else if (cnt===-1) disp.textContent='Disadvantage';
  else disp.textContent=String(cnt);
}

function updateSettings(){
  const cnt=parseInt(document.getElementById('count').value);
  state.count=cnt;
  state.modifier=parseInt(document.getElementById('modifier').value)||0;
  updateCountDisplay();
  document.getElementById('modDisplay').textContent = state.modifier;
  highlightSelectedDice();
  const modTxt = state.modifier===0 ? '' : (state.modifier>0?`+${state.modifier}`:`${state.modifier}`);
  let dicePart = (cnt>0? cnt : 1) + 'd' + state.faces;
  if(cnt===0) dicePart = 'Adv d'+state.faces;
  if(cnt===-1) dicePart = 'Dis d'+state.faces;
  document.getElementById('settings').textContent = `Current: ${dicePart}${modTxt}`;
}

function saveHistory(){
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state.history)); }catch{}
}
function loadHistory(){
  try{ const raw=localStorage.getItem(STORAGE_KEY); if(raw){ const arr=JSON.parse(raw); if(Array.isArray(arr)) state.history=arr; } }catch{}
}
function clearSavedHistory(){
  try{ localStorage.removeItem(STORAGE_KEY); }catch{}
}

// UI wiring
rollBtn.onclick=performRoll;
clearHistory.onclick=()=>{ if(confirm('Clear history?')){ state.history=[]; clearSavedHistory(); renderHistory(); } };

decrCount.onclick=()=>{
  const hidden=document.getElementById('count');
  let v=parseInt(hidden.value);
  if(isNaN(v)) v=1;
  if(v>1){
    v=v-1;
  } else if(v===1){
    v=0; // go to Advantage
  } else if(v===0){
    v=-1; // go to Disadvantage
  } else {
    v=-1; // clamp at Disadvantage
  }
  hidden.value=v; updateSettings();
};

incrCount.onclick=()=>{
  const hidden=document.getElementById('count');
  let v=parseInt(hidden.value);
  if(isNaN(v)) v=1;
  if(v===-1){
    v=0; // from Disadvantage to Advantage
  } else if(v===0){
    v=1; // from Advantage to 1
  } else if(v<20){
    v=v+1;
  }
  hidden.value=v; updateSettings();
};

// Modifier +/-
decrMod.onclick=()=>{ const v=parseInt(document.getElementById('modifier').value)||0; document.getElementById('modifier').value = v-1; updateSettings(); };
incrMod.onclick=()=>{ const v=parseInt(document.getElementById('modifier').value)||0; document.getElementById('modifier').value = v+1; updateSettings(); };

// Init
buildDiceButtons();
loadHistory();
renderHistory();
updateSettings();
</script>
</body>
</html>
